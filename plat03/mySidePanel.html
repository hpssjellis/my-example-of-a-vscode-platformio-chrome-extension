<!DOCTYPE html>
<html>
<head>
    <title>PlatformIO Sender</title>
    <style>
        body { font-family: sans-serif; padding: 10px; }
        textarea { width: 95%; height: 200px; margin-bottom: 10px; border: 1px solid #ccc; padding: 5px; font-family: monospace; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select { padding: 8px; margin-bottom: 10px; width: 98%; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #007ACC; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #myStatusMessage { margin-top: 10px; padding: 8px; background-color: #f0f0f0; border: 1px solid #ddd; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 3px; border-left: 3px solid #007ACC; }
        .log-info { border-left-color: #007ACC; }
        .log-success { border-left-color: green; }
        .log-error { border-left-color: red; }
        .log-warning { border-left-color: orange; }
    </style>
</head>
<body>
    <h3 style="color: #007ACC;">Arduino Code Sender</h3>
    
    <label for="myBoardSelector">Select Target Board:</label>
    <select id="myBoardSelector">
        <option value="nano33ble">Nano 33 BLE Sense</option>
        <option value="uno" selected>Arduino Uno</option>
        <option value="nano">Arduino Nano</option>
    </select>

    <textarea id="myArduinoCode" placeholder="void setup() { ... }"></textarea>
    
    <button id="myCompileButton" onclick="mySendCodeToPlatformIO()">Compile & Flash</button>
    
    <div id="myStatusMessage">
        <div class="log-entry log-info">[READY] System initialized and ready.</div>
    </div>

    <script>
        // mySidePanel.js (Embedded with Enhanced Logging)

        // Descriptive, camelCase variables for elements
        const myCodeElement = document.getElementById("myArduinoCode");
        const myBoardElement = document.getElementById("myBoardSelector");
        const myStatusElement = document.getElementById("myStatusMessage");
        const myCompileButton = document.getElementById("myCompileButton");
        
        // The URL for the local server bridge (must match Node.js server)
        const myLocalServerUrl = "http://localhost:8080/compile-flash";

        // Log array to keep track of all messages
        let myLogMessages = [];

        // Helper function to add log entries
        function myAddLog(myMessage, myType = "info") {
            const myTimestamp = new Date().toLocaleTimeString();
            const myLogEntry = `[${myTimestamp}] ${myMessage}`;
            myLogMessages.push({ message: myLogEntry, type: myType });
            
            console.log(`[${myType.toUpperCase()}] ${myMessage}`);
            myRenderLogs();
        }

        // Render all logs to the status element
        function myRenderLogs() {
            myStatusElement.innerHTML = myLogMessages
                .map(log => `<div class="log-entry log-${log.type}">${log.message}</div>`)
                .join('');
            myStatusElement.scrollTop = myStatusElement.scrollHeight;
        }

        // Clear logs
        function myClearLogs() {
            myLogMessages = [];
            myAddLog("Logs cleared", "info");
        }

        // The main function for sending the code (async/await preferred)
        async function mySendCodeToPlatformIO() {
            const myCode = myCodeElement.value;
            const myBoard = myBoardElement.value;
            
            myAddLog("=== COMPILE & FLASH STARTED ===", "info");
            myAddLog(`Selected board: ${myBoard}`, "info");
            myAddLog(`Code length: ${myCode.length} characters`, "info");
            
            if (!myCode.trim()) {
                myAddLog("ERROR: No code provided", "error");
                return;
            }

            // Disable button during processing
            myCompileButton.disabled = true;
            myCompileButton.textContent = "Processing...";

            myAddLog(`Connecting to server at ${myLocalServerUrl}...`, "info");

            try {
                // Send data to the local bridge server
                myAddLog("Sending POST request with code and board selection...", "info");
                
                const myResponse = await fetch(myLocalServerUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: myCode, board: myBoard }) 
                });

                myAddLog(`Server responded with status: ${myResponse.status} ${myResponse.statusText}`, 
                    myResponse.ok ? "success" : "warning");

                if (myResponse.ok) {
                    const myResult = await myResponse.json();
                    myAddLog("SUCCESS: Compilation and upload completed!", "success");
                    myAddLog(myResult.message, "success");
                    
                    if (myResult.output) {
                        myAddLog("=== SERVER OUTPUT ===", "info");
                        myAddLog(myResult.output, "info");
                    }
                } else {
                    const myResult = await myResponse.json();
                    myAddLog("FAILURE: Server returned an error", "error");
                    myAddLog(myResult.message, "error");
                    
                    if (myResult.error) {
                        myAddLog("=== ERROR DETAILS ===", "error");
                        myAddLog(myResult.error, "error");
                    }
                }
            } catch (myError) {
                myAddLog("CONNECTION ERROR: Cannot reach local bridge server", "error");
                myAddLog(`Is the server running at ${myLocalServerUrl}?`, "error");
                myAddLog(`Error details: ${myError.message}`, "error");
                console.error("Fetch Error:", myError);
            } finally {
                // Re-enable button
                myCompileButton.disabled = false;
                myCompileButton.textContent = "Compile & Flash";
                myAddLog("=== OPERATION COMPLETED ===", "info");
            }
        }

        // Example code pre-filled
        myCodeElement.value = `void setup() {
  Serial.begin(9600);
  pinMode(LED_BUILTIN, OUTPUT);
}
void loop() {
  digitalWrite(LED_BUILTIN, HIGH);
  delay(100);
  digitalWrite(LED_BUILTIN, LOW);
  delay(100);
  Serial.println("Flashing...");
}`;

        myAddLog("Example code loaded", "info");
        myAddLog("Select a board and click 'Compile & Flash' to begin", "info");
        
    </script>
</body>
</html>